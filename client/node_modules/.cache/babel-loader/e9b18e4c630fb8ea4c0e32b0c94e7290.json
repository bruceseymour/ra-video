{"ast":null,"code":"/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n'use strict';\n\nconst {\n  move,\n  insertText,\n  appendChild,\n  insertBefore,\n  createDocType,\n  createElement,\n  firstChildByTag\n} = require('../NodeUtils');\n\nconst {\n  AMP_FORMATS,\n  AMP_TAGS\n} = require('../AmpConstants');\n\nconst DEFAULT_FORMAT = 'AMP';\nconst AUTO_GENERATED_MARKER = 'data-auto';\nconst BOILERPLATES = {\n  AMP: [{\n    matcher: {\n      tagName: 'meta',\n      attribs: {\n        charset: 'utf-8'\n      }\n    },\n    node: {\n      tagName: 'meta',\n      attribs: {\n        charset: 'utf-8'\n      }\n    }\n  }, {\n    matcher: {\n      tagName: 'meta',\n      attribs: {\n        name: 'viewport'\n      }\n    },\n    node: {\n      tagName: 'meta',\n      attribs: {\n        name: 'viewport',\n        content: 'width=device-width,minimum-scale=1,initial-scale=1'\n      }\n    }\n  }, {\n    matcher: {\n      tagName: 'noscript'\n    },\n    node: {\n      tagName: 'noscript',\n      children: [{\n        tagName: 'style',\n        attribs: {\n          'amp-boilerplate': ''\n        },\n        // eslint-disable-next-line max-len\n        text: 'body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}'\n      }]\n    }\n  }, {\n    matcher: {\n      tagName: 'style',\n      attribs: {\n        'amp-boilerplate': ''\n      }\n    },\n    node: {\n      tagName: 'style',\n      attribs: {\n        'amp-boilerplate': ''\n      },\n      // eslint-disable-next-line max-len\n      text: 'body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}'\n    }\n  }, {\n    matcher: {\n      tagName: 'script',\n      attribs: {\n        src: /^https:\\/\\/.+\\/v0\\.js$/\n      }\n    },\n    node: {\n      tagName: 'script',\n      attribs: {\n        async: '',\n        src: 'https://cdn.ampproject.org/v0.js'\n      }\n    }\n  }, {\n    matcher: {\n      tagName: 'link',\n      attribs: {\n        rel: 'canonical'\n      }\n    },\n    node: {\n      tagName: 'link',\n      attribs: {\n        rel: 'canonical',\n        href: (params, log) => {\n          if (!params.canonical) {\n            log.warn('No canonical param is given. Setting canonical href to `.`');\n            params.canonical = '.';\n          }\n\n          return params.canonical;\n        }\n      }\n    }\n  }]\n};\n/**\n * AddMandatoryTags - this transformer will automatically add all missing tags required by a valid AMP document.\n *\n * This transformer will only add missing tags required by a valid AMP documents. However, it won't\n * remove or convert invalid elements. This transformer supports the following option:\n *\n * - `format: [AMP|AMP4EMAIL|AMP4ADS]` - specifies the AMP format. Defaults to `AMP`.\n * - `autoAddMandatoryTags: [true|false]` - set to `false` to disable auto adding the boilerplate.\n */\n\nclass AddMandatoryTags {\n  constructor(config) {\n    // autoAddBoilerplate is the deprecated parameter\n    this.enabled = config.autoAddBoilerplate !== false && config.autoAddMandatoryTags !== false;\n    this.format = config.format || DEFAULT_FORMAT;\n    this.log_ = config.log.tag('AddMandatoryTags');\n  }\n\n  async transform(root, params) {\n    if (!this.enabled) {\n      return;\n    } // Set default canonical if non is given\n    // Validate format string\n\n\n    if (!AMP_FORMATS.includes(this.format)) {\n      this.log_.error('Unknown AMPHTML format', this.format);\n      return;\n    } // Only supports AMP for websites\n\n\n    const boilerplateSpec = BOILERPLATES[this.format];\n\n    if (!boilerplateSpec) {\n      this.log_.info('Unsupported AMP format', this.format);\n      return;\n    } // Get or create the html tag\n\n\n    let html = firstChildByTag(root, 'html');\n\n    if (!html) {\n      html = this.createHtml5Document(root);\n    } // Add the doctype if none is present\n\n\n    let doctype = root.children.find(child => child.type === 'directive' && child.name === '!doctype');\n\n    if (!doctype) {\n      doctype = createDocType();\n      insertBefore(root, doctype, root.firstChild);\n    } // Mark as AMP in html tag if not present\n\n\n    if (!Object.keys(html.attribs).some(a => AMP_TAGS.includes(a))) {\n      html.attribs[this.format.toLowerCase()] = '';\n    } // Get the head element\n\n\n    let head = firstChildByTag(html, 'head');\n\n    if (!head) {\n      head = createElement('head');\n      appendChild(html, head);\n    } // Match each head node against the boilerplate spec, mark\n    // all matched nodes by removing them from the set of boilerplate\n    // nodes\n\n\n    const boilerplateRules = new Set(boilerplateSpec);\n    let node = head.firstChild;\n\n    while (node) {\n      if (node.tagName) {\n        boilerplateRules.forEach(spec => {\n          if (this.matchSpec(spec.matcher, node)) {\n            boilerplateRules.delete(spec);\n          }\n        });\n      }\n\n      node = node.nextSibling;\n    } // Add all missing nodes\n\n\n    for (const spec of boilerplateRules) {\n      this.addNode(head, spec.node, params);\n    }\n  }\n  /**\n   * @private\n   */\n\n\n  matchSpec(matcher, node) {\n    if (matcher.tagName !== node.tagName) {\n      return false;\n    }\n\n    if (!matcher.attribs) {\n      return true;\n    }\n\n    for (const [key, value] of Object.entries(matcher.attribs)) {\n      const attributeValue = node.attribs[key];\n\n      if (value instanceof RegExp) {\n        if (!value.test(attributeValue)) {\n          return false;\n        }\n      } else if (attributeValue !== value) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n  /**\n   * @private\n   */\n\n\n  addNode(parent, nodeSpec, params) {\n    const defaultAttribs = {};\n    defaultAttribs[AUTO_GENERATED_MARKER] = '';\n    const newElement = createElement(nodeSpec.tagName, defaultAttribs);\n    this.addAttributes(nodeSpec, newElement, params);\n    this.addChildren(nodeSpec, newElement, params);\n    this.addText(nodeSpec, newElement, params);\n    appendChild(parent, newElement);\n  }\n  /**\n   * @private\n   */\n\n\n  addText(nodeSpec, newElement, params) {\n    if (!nodeSpec.text) {\n      return;\n    }\n\n    let text;\n\n    if (typeof nodeSpec.text === 'function') {\n      text = nodeSpec.text(params, this.log_);\n    } else {\n      text = nodeSpec.text;\n    }\n\n    insertText(newElement, text);\n  }\n  /**\n   * @private\n   */\n\n\n  addChildren(nodeSpec, newElement, params) {\n    if (!nodeSpec.children) {\n      return;\n    }\n\n    for (const child of nodeSpec.children) {\n      this.addNode(newElement, child, params);\n    }\n  }\n  /**\n   * @private\n   */\n\n\n  addAttributes(nodeSpec, newElement, params) {\n    if (!nodeSpec.attribs) {\n      return;\n    }\n\n    for (const [key, value] of Object.entries(nodeSpec.attribs)) {\n      if (typeof value === 'function') {\n        newElement.attribs[key] = value(params, this.log_);\n      } else {\n        newElement.attribs[key] = value;\n      }\n    }\n  }\n  /**\n   * Tries to re-construct a valid HTML5 doc from a document missing the HTML tag.\n   *\n   * @private\n   */\n\n\n  createHtml5Document(root) {\n    const html = createElement('html', {});\n    const head = this.createOrMoveElement(root, html, 'head');\n    const body = this.createOrMoveElement(root, html, 'body');\n    this.copyTagsToHeadAndBody(root, head, body);\n    appendChild(root, html);\n    return html;\n  }\n  /**\n   * @private\n   */\n\n\n  createOrMoveElement(root, html, name) {\n    const element = firstChildByTag(root, name) || createElement(name);\n    move(element, html);\n    return element;\n  }\n  /**\n   * @private\n   */\n\n\n  copyTagsToHeadAndBody(root, head, body) {\n    let node = root.firstChild;\n\n    while (node) {\n      const nodeToMove = node;\n      node = nodeToMove.next;\n\n      if (nodeToMove.type === 'directive') {// ignore and keep in root\n      } else if (nodeToMove.tagName === 'title') {\n        // there might be more head only tags\n        move(nodeToMove, head);\n      } else {\n        // by default move nodes to body\n        move(nodeToMove, body);\n      }\n    }\n  }\n\n}\n\nmodule.exports = AddMandatoryTags;","map":{"version":3,"sources":["/Users/bruceseymour/ra-video/client/node_modules/@ampproject/toolbox-optimizer/lib/transformers/AddMandatoryTags.js"],"names":["move","insertText","appendChild","insertBefore","createDocType","createElement","firstChildByTag","require","AMP_FORMATS","AMP_TAGS","DEFAULT_FORMAT","AUTO_GENERATED_MARKER","BOILERPLATES","AMP","matcher","tagName","attribs","charset","node","name","content","children","text","src","async","rel","href","params","log","canonical","warn","AddMandatoryTags","constructor","config","enabled","autoAddBoilerplate","autoAddMandatoryTags","format","log_","tag","transform","root","includes","error","boilerplateSpec","info","html","createHtml5Document","doctype","find","child","type","firstChild","Object","keys","some","a","toLowerCase","head","boilerplateRules","Set","forEach","spec","matchSpec","delete","nextSibling","addNode","key","value","entries","attributeValue","RegExp","test","parent","nodeSpec","defaultAttribs","newElement","addAttributes","addChildren","addText","createOrMoveElement","body","copyTagsToHeadAndBody","element","nodeToMove","next","module","exports"],"mappings":"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","sourcesContent":["/**\n * Copyright 2020 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n'use strict';\n\nconst {\n  move,\n  insertText,\n  appendChild,\n  insertBefore,\n  createDocType,\n  createElement,\n  firstChildByTag,\n} = require('../NodeUtils');\nconst {AMP_FORMATS, AMP_TAGS} = require('../AmpConstants');\n\nconst DEFAULT_FORMAT = 'AMP';\nconst AUTO_GENERATED_MARKER = 'data-auto';\n\nconst BOILERPLATES = {\n  AMP: [\n    {\n      matcher: {\n        tagName: 'meta',\n        attribs: {\n          charset: 'utf-8',\n        },\n      },\n      node: {\n        tagName: 'meta',\n        attribs: {\n          charset: 'utf-8',\n        },\n      },\n    },\n    {\n      matcher: {\n        tagName: 'meta',\n        attribs: {\n          name: 'viewport',\n        },\n      },\n      node: {\n        tagName: 'meta',\n        attribs: {\n          name: 'viewport',\n          content: 'width=device-width,minimum-scale=1,initial-scale=1',\n        },\n      },\n    },\n    {\n      matcher: {\n        tagName: 'noscript',\n      },\n      node: {\n        tagName: 'noscript',\n        children: [\n          {\n            tagName: 'style',\n            attribs: {\n              'amp-boilerplate': '',\n            },\n            // eslint-disable-next-line max-len\n            text:\n              'body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}',\n          },\n        ],\n      },\n    },\n    {\n      matcher: {\n        tagName: 'style',\n        attribs: {\n          'amp-boilerplate': '',\n        },\n      },\n      node: {\n        tagName: 'style',\n        attribs: {\n          'amp-boilerplate': '',\n        },\n        // eslint-disable-next-line max-len\n        text:\n          'body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}',\n      },\n    },\n    {\n      matcher: {\n        tagName: 'script',\n        attribs: {\n          src: /^https:\\/\\/.+\\/v0\\.js$/,\n        },\n      },\n      node: {\n        tagName: 'script',\n        attribs: {\n          async: '',\n          src: 'https://cdn.ampproject.org/v0.js',\n        },\n      },\n    },\n    {\n      matcher: {\n        tagName: 'link',\n        attribs: {\n          rel: 'canonical',\n        },\n      },\n      node: {\n        tagName: 'link',\n        attribs: {\n          rel: 'canonical',\n          href: (params, log) => {\n            if (!params.canonical) {\n              log.warn('No canonical param is given. Setting canonical href to `.`');\n              params.canonical = '.';\n            }\n            return params.canonical;\n          },\n        },\n      },\n    },\n  ],\n};\n\n/**\n * AddMandatoryTags - this transformer will automatically add all missing tags required by a valid AMP document.\n *\n * This transformer will only add missing tags required by a valid AMP documents. However, it won't\n * remove or convert invalid elements. This transformer supports the following option:\n *\n * - `format: [AMP|AMP4EMAIL|AMP4ADS]` - specifies the AMP format. Defaults to `AMP`.\n * - `autoAddMandatoryTags: [true|false]` - set to `false` to disable auto adding the boilerplate.\n */\nclass AddMandatoryTags {\n  constructor(config) {\n    // autoAddBoilerplate is the deprecated parameter\n    this.enabled = config.autoAddBoilerplate !== false && config.autoAddMandatoryTags !== false;\n    this.format = config.format || DEFAULT_FORMAT;\n    this.log_ = config.log.tag('AddMandatoryTags');\n  }\n\n  async transform(root, params) {\n    if (!this.enabled) {\n      return;\n    }\n\n    // Set default canonical if non is given\n    // Validate format string\n    if (!AMP_FORMATS.includes(this.format)) {\n      this.log_.error('Unknown AMPHTML format', this.format);\n      return;\n    }\n\n    // Only supports AMP for websites\n    const boilerplateSpec = BOILERPLATES[this.format];\n    if (!boilerplateSpec) {\n      this.log_.info('Unsupported AMP format', this.format);\n      return;\n    }\n\n    // Get or create the html tag\n    let html = firstChildByTag(root, 'html');\n    if (!html) {\n      html = this.createHtml5Document(root);\n    }\n\n    // Add the doctype if none is present\n    let doctype = root.children.find(\n      (child) => child.type === 'directive' && child.name === '!doctype'\n    );\n    if (!doctype) {\n      doctype = createDocType();\n      insertBefore(root, doctype, root.firstChild);\n    }\n\n    // Mark as AMP in html tag if not present\n    if (!Object.keys(html.attribs).some((a) => AMP_TAGS.includes(a))) {\n      html.attribs[this.format.toLowerCase()] = '';\n    }\n\n    // Get the head element\n    let head = firstChildByTag(html, 'head');\n    if (!head) {\n      head = createElement('head');\n      appendChild(html, head);\n    }\n\n    // Match each head node against the boilerplate spec, mark\n    // all matched nodes by removing them from the set of boilerplate\n    // nodes\n    const boilerplateRules = new Set(boilerplateSpec);\n    let node = head.firstChild;\n    while (node) {\n      if (node.tagName) {\n        boilerplateRules.forEach((spec) => {\n          if (this.matchSpec(spec.matcher, node)) {\n            boilerplateRules.delete(spec);\n          }\n        });\n      }\n      node = node.nextSibling;\n    }\n\n    // Add all missing nodes\n    for (const spec of boilerplateRules) {\n      this.addNode(head, spec.node, params);\n    }\n  }\n\n  /**\n   * @private\n   */\n  matchSpec(matcher, node) {\n    if (matcher.tagName !== node.tagName) {\n      return false;\n    }\n    if (!matcher.attribs) {\n      return true;\n    }\n    for (const [key, value] of Object.entries(matcher.attribs)) {\n      const attributeValue = node.attribs[key];\n      if (value instanceof RegExp) {\n        if (!value.test(attributeValue)) {\n          return false;\n        }\n      } else if (attributeValue !== value) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  /**\n   * @private\n   */\n  addNode(parent, nodeSpec, params) {\n    const defaultAttribs = {};\n    defaultAttribs[AUTO_GENERATED_MARKER] = '';\n    const newElement = createElement(nodeSpec.tagName, defaultAttribs);\n    this.addAttributes(nodeSpec, newElement, params);\n    this.addChildren(nodeSpec, newElement, params);\n    this.addText(nodeSpec, newElement, params);\n    appendChild(parent, newElement);\n  }\n\n  /**\n   * @private\n   */\n  addText(nodeSpec, newElement, params) {\n    if (!nodeSpec.text) {\n      return;\n    }\n    let text;\n    if (typeof nodeSpec.text === 'function') {\n      text = nodeSpec.text(params, this.log_);\n    } else {\n      text = nodeSpec.text;\n    }\n    insertText(newElement, text);\n  }\n\n  /**\n   * @private\n   */\n  addChildren(nodeSpec, newElement, params) {\n    if (!nodeSpec.children) {\n      return;\n    }\n    for (const child of nodeSpec.children) {\n      this.addNode(newElement, child, params);\n    }\n  }\n\n  /**\n   * @private\n   */\n  addAttributes(nodeSpec, newElement, params) {\n    if (!nodeSpec.attribs) {\n      return;\n    }\n    for (const [key, value] of Object.entries(nodeSpec.attribs)) {\n      if (typeof value === 'function') {\n        newElement.attribs[key] = value(params, this.log_);\n      } else {\n        newElement.attribs[key] = value;\n      }\n    }\n  }\n\n  /**\n   * Tries to re-construct a valid HTML5 doc from a document missing the HTML tag.\n   *\n   * @private\n   */\n  createHtml5Document(root) {\n    const html = createElement('html', {});\n    const head = this.createOrMoveElement(root, html, 'head');\n    const body = this.createOrMoveElement(root, html, 'body');\n    this.copyTagsToHeadAndBody(root, head, body);\n    appendChild(root, html);\n    return html;\n  }\n\n  /**\n   * @private\n   */\n  createOrMoveElement(root, html, name) {\n    const element = firstChildByTag(root, name) || createElement(name);\n    move(element, html);\n    return element;\n  }\n\n  /**\n   * @private\n   */\n  copyTagsToHeadAndBody(root, head, body) {\n    let node = root.firstChild;\n    while (node) {\n      const nodeToMove = node;\n      node = nodeToMove.next;\n      if (nodeToMove.type === 'directive') {\n        // ignore and keep in root\n      } else if (nodeToMove.tagName === 'title') {\n        // there might be more head only tags\n        move(nodeToMove, head);\n      } else {\n        // by default move nodes to body\n        move(nodeToMove, body);\n      }\n    }\n  }\n}\n\nmodule.exports = AddMandatoryTags;\n"]},"metadata":{},"sourceType":"script"}