{"ast":null,"code":"/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n'use strict';\n\nconst {\n  firstChildByTag\n} = require('../NodeUtils');\n\nconst HINT_TAGS = new Set(['dns-prefetch', 'preconnect', 'prefetch', 'preload', 'prerender']);\n/**\n * Removes duplicate browser resource hint link header directives.\n *\n * To avoid wasted requests for preloaded resources strip references to duplicate\n * items.\n */\n\nclass PruneDuplicateResourceHints {\n  transform(tree) {\n    const preloaded = new Map();\n    const html = firstChildByTag(tree, 'html');\n\n    if (!html) {\n      return;\n    }\n\n    const head = firstChildByTag(html, 'head');\n\n    if (!head) {\n      return;\n    }\n\n    const childNodes = [];\n\n    for (let node = head.firstChild; node !== null; node = node.nextSibling) {\n      if (this._notPruneableHintLink(node)) {\n        childNodes.push(node);\n      } else if (!this._alreadyLoaded(node, preloaded)) {\n        this._markPreloaded(node, preloaded);\n\n        childNodes.push(node);\n      }\n    } // replace the child node list\n\n\n    head.childNodes = childNodes;\n  }\n\n  _notPruneableHintLink(node) {\n    if (node.tagName !== 'link') {\n      return true;\n    }\n\n    if (!node.attribs) {\n      return true;\n    }\n\n    if (!node.attribs.rel) {\n      return true;\n    }\n\n    if (!node.attribs.href) {\n      return true;\n    }\n\n    if (node.attribs.rel === 'preload' && !node.attribs.as) {\n      return true;\n    }\n\n    return !HINT_TAGS.has(node.attribs.rel);\n  }\n\n  _alreadyLoaded(link, preloaded) {\n    const rel = link.attribs.rel;\n    const href = link.attribs.href;\n\n    if (!preloaded.has(href)) {\n      return false;\n    }\n\n    const relations = preloaded.get(href);\n    return relations.has(rel);\n  }\n\n  _markPreloaded(link, preloaded) {\n    const rel = link.attribs.rel;\n    const href = link.attribs.href;\n    let relations = preloaded.get(href);\n\n    if (!relations) {\n      relations = new Set();\n      preloaded.set(href, relations);\n    }\n\n    relations.add(rel);\n  }\n\n}\n\nmodule.exports = PruneDuplicateResourceHints;","map":{"version":3,"sources":["/Users/bruceseymour/ra-video/client/node_modules/@ampproject/toolbox-optimizer/lib/transformers/PruneDuplicateResourceHints.js"],"names":["firstChildByTag","require","HINT_TAGS","Set","PruneDuplicateResourceHints","transform","tree","preloaded","Map","html","head","childNodes","node","firstChild","nextSibling","_notPruneableHintLink","push","_alreadyLoaded","_markPreloaded","tagName","attribs","rel","href","as","has","link","relations","get","set","add","module","exports"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;AAEA,MAAM;AAACA,EAAAA;AAAD,IAAoBC,OAAO,CAAC,cAAD,CAAjC;;AACA,MAAMC,SAAS,GAAG,IAAIC,GAAJ,CAAQ,CAAC,cAAD,EAAiB,YAAjB,EAA+B,UAA/B,EAA2C,SAA3C,EAAsD,WAAtD,CAAR,CAAlB;AAEA;AACA;AACA;AACA;AACA;AACA;;AACA,MAAMC,2BAAN,CAAkC;AAChCC,EAAAA,SAAS,CAACC,IAAD,EAAO;AACd,UAAMC,SAAS,GAAG,IAAIC,GAAJ,EAAlB;AACA,UAAMC,IAAI,GAAGT,eAAe,CAACM,IAAD,EAAO,MAAP,CAA5B;;AACA,QAAI,CAACG,IAAL,EAAW;AACT;AACD;;AACD,UAAMC,IAAI,GAAGV,eAAe,CAACS,IAAD,EAAO,MAAP,CAA5B;;AACA,QAAI,CAACC,IAAL,EAAW;AACT;AACD;;AACD,UAAMC,UAAU,GAAG,EAAnB;;AACA,SAAK,IAAIC,IAAI,GAAGF,IAAI,CAACG,UAArB,EAAiCD,IAAI,KAAK,IAA1C,EAAgDA,IAAI,GAAGA,IAAI,CAACE,WAA5D,EAAyE;AACvE,UAAI,KAAKC,qBAAL,CAA2BH,IAA3B,CAAJ,EAAsC;AACpCD,QAAAA,UAAU,CAACK,IAAX,CAAgBJ,IAAhB;AACD,OAFD,MAEO,IAAI,CAAC,KAAKK,cAAL,CAAoBL,IAApB,EAA0BL,SAA1B,CAAL,EAA2C;AAChD,aAAKW,cAAL,CAAoBN,IAApB,EAA0BL,SAA1B;;AACAI,QAAAA,UAAU,CAACK,IAAX,CAAgBJ,IAAhB;AACD;AACF,KAlBa,CAmBd;;;AACAF,IAAAA,IAAI,CAACC,UAAL,GAAkBA,UAAlB;AACD;;AAEDI,EAAAA,qBAAqB,CAACH,IAAD,EAAO;AAC1B,QAAIA,IAAI,CAACO,OAAL,KAAiB,MAArB,EAA6B;AAC3B,aAAO,IAAP;AACD;;AACD,QAAI,CAACP,IAAI,CAACQ,OAAV,EAAmB;AACjB,aAAO,IAAP;AACD;;AACD,QAAI,CAACR,IAAI,CAACQ,OAAL,CAAaC,GAAlB,EAAuB;AACrB,aAAO,IAAP;AACD;;AACD,QAAI,CAACT,IAAI,CAACQ,OAAL,CAAaE,IAAlB,EAAwB;AACtB,aAAO,IAAP;AACD;;AACD,QAAIV,IAAI,CAACQ,OAAL,CAAaC,GAAb,KAAqB,SAArB,IAAkC,CAACT,IAAI,CAACQ,OAAL,CAAaG,EAApD,EAAwD;AACtD,aAAO,IAAP;AACD;;AACD,WAAO,CAACrB,SAAS,CAACsB,GAAV,CAAcZ,IAAI,CAACQ,OAAL,CAAaC,GAA3B,CAAR;AACD;;AAEDJ,EAAAA,cAAc,CAACQ,IAAD,EAAOlB,SAAP,EAAkB;AAC9B,UAAMc,GAAG,GAAGI,IAAI,CAACL,OAAL,CAAaC,GAAzB;AACA,UAAMC,IAAI,GAAGG,IAAI,CAACL,OAAL,CAAaE,IAA1B;;AACA,QAAI,CAACf,SAAS,CAACiB,GAAV,CAAcF,IAAd,CAAL,EAA0B;AACxB,aAAO,KAAP;AACD;;AACD,UAAMI,SAAS,GAAGnB,SAAS,CAACoB,GAAV,CAAcL,IAAd,CAAlB;AACA,WAAOI,SAAS,CAACF,GAAV,CAAcH,GAAd,CAAP;AACD;;AAEDH,EAAAA,cAAc,CAACO,IAAD,EAAOlB,SAAP,EAAkB;AAC9B,UAAMc,GAAG,GAAGI,IAAI,CAACL,OAAL,CAAaC,GAAzB;AACA,UAAMC,IAAI,GAAGG,IAAI,CAACL,OAAL,CAAaE,IAA1B;AACA,QAAII,SAAS,GAAGnB,SAAS,CAACoB,GAAV,CAAcL,IAAd,CAAhB;;AACA,QAAI,CAACI,SAAL,EAAgB;AACdA,MAAAA,SAAS,GAAG,IAAIvB,GAAJ,EAAZ;AACAI,MAAAA,SAAS,CAACqB,GAAV,CAAcN,IAAd,EAAoBI,SAApB;AACD;;AACDA,IAAAA,SAAS,CAACG,GAAV,CAAcR,GAAd;AACD;;AA9D+B;;AAiElCS,MAAM,CAACC,OAAP,GAAiB3B,2BAAjB","sourcesContent":["/**\n * Copyright 2018 The AMP HTML Authors. All Rights Reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS-IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n'use strict';\n\nconst {firstChildByTag} = require('../NodeUtils');\nconst HINT_TAGS = new Set(['dns-prefetch', 'preconnect', 'prefetch', 'preload', 'prerender']);\n\n/**\n * Removes duplicate browser resource hint link header directives.\n *\n * To avoid wasted requests for preloaded resources strip references to duplicate\n * items.\n */\nclass PruneDuplicateResourceHints {\n  transform(tree) {\n    const preloaded = new Map();\n    const html = firstChildByTag(tree, 'html');\n    if (!html) {\n      return;\n    }\n    const head = firstChildByTag(html, 'head');\n    if (!head) {\n      return;\n    }\n    const childNodes = [];\n    for (let node = head.firstChild; node !== null; node = node.nextSibling) {\n      if (this._notPruneableHintLink(node)) {\n        childNodes.push(node);\n      } else if (!this._alreadyLoaded(node, preloaded)) {\n        this._markPreloaded(node, preloaded);\n        childNodes.push(node);\n      }\n    }\n    // replace the child node list\n    head.childNodes = childNodes;\n  }\n\n  _notPruneableHintLink(node) {\n    if (node.tagName !== 'link') {\n      return true;\n    }\n    if (!node.attribs) {\n      return true;\n    }\n    if (!node.attribs.rel) {\n      return true;\n    }\n    if (!node.attribs.href) {\n      return true;\n    }\n    if (node.attribs.rel === 'preload' && !node.attribs.as) {\n      return true;\n    }\n    return !HINT_TAGS.has(node.attribs.rel);\n  }\n\n  _alreadyLoaded(link, preloaded) {\n    const rel = link.attribs.rel;\n    const href = link.attribs.href;\n    if (!preloaded.has(href)) {\n      return false;\n    }\n    const relations = preloaded.get(href);\n    return relations.has(rel);\n  }\n\n  _markPreloaded(link, preloaded) {\n    const rel = link.attribs.rel;\n    const href = link.attribs.href;\n    let relations = preloaded.get(href);\n    if (!relations) {\n      relations = new Set();\n      preloaded.set(href, relations);\n    }\n    relations.add(rel);\n  }\n}\n\nmodule.exports = PruneDuplicateResourceHints;\n"]},"metadata":{},"sourceType":"script"}