{"ast":null,"code":"\"use strict\";\n\nexports.__esModule = true;\nexports.WebpackHotMiddleware = void 0; // Based on https://github.com/webpack-contrib/webpack-hot-middleware/blob/9708d781ae0e46179cf8ea1a94719de4679aaf53/middleware.js\n// Included License below\n// Copyright JS Foundation and other contributors\n// Permission is hereby granted, free of charge, to any person obtaining\n// a copy of this software and associated documentation files (the\n// 'Software'), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to\n// permit persons to whom the Software is furnished to do so, subject to\n// the following conditions:\n// The above copyright notice and this permission notice shall be\n// included in all copies or substantial portions of the Software.\n// THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,\n// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.\n// IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY\n// CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,\n// TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n// SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\nclass WebpackHotMiddleware {\n  constructor(compiler) {\n    this.eventStream = void 0;\n    this.latestStats = void 0;\n    this.closed = void 0;\n\n    this.onInvalid = () => {\n      if (this.closed) return;\n      this.latestStats = null;\n      this.eventStream.publish({\n        action: 'building'\n      });\n    };\n\n    this.onDone = statsResult => {\n      if (this.closed) return; // Keep hold of latest stats so they can be propagated to new clients\n\n      this.latestStats = statsResult;\n      this.publishStats('built', this.latestStats);\n    };\n\n    this.middleware = (req, res, next) => {\n      var _req$url;\n\n      if (this.closed) return next();\n      if (!((_req$url = req.url) != null && _req$url.startsWith('/_next/webpack-hmr'))) return next();\n      this.eventStream.handler(req, res);\n\n      if (this.latestStats) {\n        // Explicitly not passing in `log` fn as we don't want to log again on\n        // the server\n        this.publishStats('sync', this.latestStats);\n      }\n    };\n\n    this.publishStats = (action, statsResult) => {\n      const stats = statsResult.toJson({\n        all: false,\n        hash: true,\n        warnings: true,\n        errors: true\n      });\n      this.eventStream.publish({\n        action: action,\n        hash: stats.hash,\n        warnings: stats.warnings || [],\n        errors: stats.errors || []\n      });\n    };\n\n    this.publish = payload => {\n      if (this.closed) return;\n      this.eventStream.publish(payload);\n    };\n\n    this.close = () => {\n      if (this.closed) return; // Can't remove compiler plugins, so we just set a flag and noop if closed\n      // https://github.com/webpack/tapable/issues/32#issuecomment-350644466\n\n      this.closed = true;\n      this.eventStream.close();\n    };\n\n    this.eventStream = new EventStream();\n    this.latestStats = null;\n    this.closed = false;\n    compiler.hooks.invalid.tap('webpack-hot-middleware', this.onInvalid);\n    compiler.hooks.done.tap('webpack-hot-middleware', this.onDone);\n  }\n\n}\n\nexports.WebpackHotMiddleware = WebpackHotMiddleware;\n\nclass EventStream {\n  constructor() {\n    this.clients = void 0;\n    this.interval = void 0;\n\n    this.heartbeatTick = () => {\n      this.everyClient(client => {\n        client.write('data: \\uD83D\\uDC93\\n\\n');\n      });\n    };\n\n    this.clients = new Set();\n    this.interval = setInterval(this.heartbeatTick, 2500).unref();\n  }\n\n  everyClient(fn) {\n    for (const client of this.clients) {\n      fn(client);\n    }\n  }\n\n  close() {\n    clearInterval(this.interval);\n    this.everyClient(client => {\n      if (!client.finished) client.end();\n    });\n    this.clients.clear();\n  }\n\n  handler(req, res) {\n    const headers = {\n      'Access-Control-Allow-Origin': '*',\n      'Content-Type': 'text/event-stream;charset=utf-8',\n      'Cache-Control': 'no-cache, no-transform',\n      // While behind nginx, event stream should not be buffered:\n      // http://nginx.org/docs/http/ngx_http_proxy_module.html#proxy_buffering\n      'X-Accel-Buffering': 'no'\n    };\n    const isHttp1 = !(parseInt(req.httpVersion) >= 2);\n\n    if (isHttp1) {\n      req.socket.setKeepAlive(true);\n      Object.assign(headers, {\n        Connection: 'keep-alive'\n      });\n    }\n\n    res.writeHead(200, headers);\n    res.write('\\n');\n    this.clients.add(res);\n    req.on('close', () => {\n      if (!res.finished) res.end();\n      this.clients.delete(res);\n    });\n  }\n\n  publish(payload) {\n    this.everyClient(client => {\n      client.write('data: ' + JSON.stringify(payload) + '\\n\\n');\n    });\n  }\n\n}","map":{"version":3,"sources":["../../server/hot-middleware.ts"],"names":["WebpackHotMiddleware","eventStream","latestStats","closed","constructor","compiler","action","statsResult","next","req","stats","all","hash","warnings","errors","payload","EventStream","clients","interval","setInterval","client","everyClient","fn","close","clearInterval","handler","headers","isHttp1","parseInt","Object","Connection","res","publish","JSON"],"mappings":"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","sourcesContent":["// Based on https://github.com/webpack-contrib/webpack-hot-middleware/blob/9708d781ae0e46179cf8ea1a94719de4679aaf53/middleware.js\n// Included License below\n\n// Copyright JS Foundation and other contributors\n\n// Permission is hereby granted, free of charge, to any person obtaining\n// a copy of this software and associated documentation files (the\n// 'Software'), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to\n// permit persons to whom the Software is furnished to do so, subject to\n// the following conditions:\n\n// The above copyright notice and this permission notice shall be\n// included in all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,\n// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.\n// IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY\n// CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,\n// TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n// SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\nimport webpack from 'webpack'\nimport http from 'http'\n\nexport class WebpackHotMiddleware {\n  eventStream: EventStream\n  latestStats: webpack.Stats | null\n  closed: boolean\n\n  constructor(compiler: webpack.Compiler) {\n    this.eventStream = new EventStream()\n    this.latestStats = null\n    this.closed = false\n\n    compiler.hooks.invalid.tap('webpack-hot-middleware', this.onInvalid)\n    compiler.hooks.done.tap('webpack-hot-middleware', this.onDone)\n  }\n\n  onInvalid = () => {\n    if (this.closed) return\n    this.latestStats = null\n    this.eventStream.publish({ action: 'building' })\n  }\n  onDone = (statsResult: webpack.Stats) => {\n    if (this.closed) return\n    // Keep hold of latest stats so they can be propagated to new clients\n    this.latestStats = statsResult\n    this.publishStats('built', this.latestStats)\n  }\n  middleware = (\n    req: http.IncomingMessage,\n    res: http.ServerResponse,\n    next: () => void\n  ) => {\n    if (this.closed) return next()\n    if (!req.url?.startsWith('/_next/webpack-hmr')) return next()\n    this.eventStream.handler(req, res)\n    if (this.latestStats) {\n      // Explicitly not passing in `log` fn as we don't want to log again on\n      // the server\n      this.publishStats('sync', this.latestStats)\n    }\n  }\n\n  publishStats = (action: string, statsResult: webpack.Stats) => {\n    const stats = statsResult.toJson({\n      all: false,\n      hash: true,\n      warnings: true,\n      errors: true,\n    })\n\n    this.eventStream.publish({\n      action: action,\n      hash: stats.hash,\n      warnings: stats.warnings || [],\n      errors: stats.errors || [],\n    })\n  }\n\n  publish = (payload: any) => {\n    if (this.closed) return\n    this.eventStream.publish(payload)\n  }\n  close = () => {\n    if (this.closed) return\n    // Can't remove compiler plugins, so we just set a flag and noop if closed\n    // https://github.com/webpack/tapable/issues/32#issuecomment-350644466\n    this.closed = true\n    this.eventStream.close()\n  }\n}\n\nclass EventStream {\n  clients: Set<http.ServerResponse>\n  interval: NodeJS.Timeout\n  constructor() {\n    this.clients = new Set()\n\n    this.interval = setInterval(this.heartbeatTick, 2500).unref()\n  }\n\n  heartbeatTick = () => {\n    this.everyClient((client) => {\n      client.write('data: \\uD83D\\uDC93\\n\\n')\n    })\n  }\n\n  everyClient(fn: (client: http.ServerResponse) => void) {\n    for (const client of this.clients) {\n      fn(client)\n    }\n  }\n\n  close() {\n    clearInterval(this.interval)\n    this.everyClient((client) => {\n      if (!client.finished) client.end()\n    })\n    this.clients.clear()\n  }\n\n  handler(req: http.IncomingMessage, res: http.ServerResponse) {\n    const headers = {\n      'Access-Control-Allow-Origin': '*',\n      'Content-Type': 'text/event-stream;charset=utf-8',\n      'Cache-Control': 'no-cache, no-transform',\n      // While behind nginx, event stream should not be buffered:\n      // http://nginx.org/docs/http/ngx_http_proxy_module.html#proxy_buffering\n      'X-Accel-Buffering': 'no',\n    }\n\n    const isHttp1 = !(parseInt(req.httpVersion) >= 2)\n    if (isHttp1) {\n      req.socket.setKeepAlive(true)\n      Object.assign(headers, {\n        Connection: 'keep-alive',\n      })\n    }\n\n    res.writeHead(200, headers)\n    res.write('\\n')\n    this.clients.add(res)\n    req.on('close', () => {\n      if (!res.finished) res.end()\n      this.clients.delete(res)\n    })\n  }\n\n  publish(payload: any) {\n    this.everyClient((client) => {\n      client.write('data: ' + JSON.stringify(payload) + '\\n\\n')\n    })\n  }\n}\n"]},"metadata":{},"sourceType":"script"}